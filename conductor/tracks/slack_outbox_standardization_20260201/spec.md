# Spec: Slack Transactional Outbox Standardization

## Problem Statement
The **Transactional Outbox Pattern** was successfully implemented in a previous track (2026-01-28) to guarantee notification delivery. However, an audit revealed that its usage is inconsistent across the codebase:
1. **Monitoring Jobs** (`jobs.py`) still call the Slack API directly.
2. **SlackAgent** (`agent.py`) exclusively uses direct API calls.
3. **Slack Handlers** (`handlers.py`) sometimes mix direct calls with outbox calls.

This inconsistency leads to "fire-and-forget" notifications that are lost if Slack is down, and makes the system harder to maintain (violates DRY).

## Goal
Standardize all Slack notifications to use the `NotificationOutbox` as the primary and only egress point for business-critical messages. Ensure the implementation is clean, centralized, and follows the architectural patterns defined in our project.

## Scope
- **Standardization**: Refactor all direct `slack_client.send_message` calls (except for the Outbox worker itself) to use `queue_notification`.
- **Centralization**: Update the `SlackAgent` and `MonitoringService` to be "outbox-aware" by requiring an `AsyncSession`.
- **DRY**: Ensure that all notifications follow the same reliability and retry logic provided by the outbox framework.
- **Documentation**: Create a `slack-outbox` skill and architectural documentation.

## Out of Scope
- Changing the Slack message format (Block Kit).
- Modifying the `SlackClient` low-level implementation (except for maintenance).
- Non-Slack notifications (e.g., email) - though the outbox is designed to be extensible.

## Success Criteria
1. **No direct calls**: `grep` for `send_message` should only find matches in `notification_outbox.py` (processor) and low-level tests.
2. **Monitoring alerts**: Alerts generated by background jobs are correctly queued in the outbox.
3. **Slack Agent reliability**: All methods in `SlackAgent` use the outbox.
4. **Clean Handlers**: Redundant direct calls in `handlers.py` are removed.
5. **Skill creation**: The `slack-outbox` skill is created and registered.

## Technical Requirements
- **AsyncSession injection**: All services/agents that send notifications must have access to a database session.
- **Atomic commits**: Notifications must always be queued within the same transaction that updates business state.
- **Worker monitoring**: Ensure the `outbox_worker` is active and healthy.

## References
- [Microservices.io: Transactional Outbox Pattern](https://microservices.io/patterns/data/transactional-outbox.html)
- `src/pa_dealing/services/notification_outbox.py` (Implementation)
- `src/pa_dealing/db/models/notification.py` (Model)
